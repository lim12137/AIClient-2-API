<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API å¤§é”…é¥­ - Key ç®¡ç†</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            background: #0d1117;
            min-height: 100vh; 
            color: #e6edf3;
        }
        
        /* é¡¶éƒ¨å¯¼èˆª */
        .navbar {
            background: #161b22;
            border-bottom: 1px solid #30363d;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .navbar-inner {
            max-width: 1000px;
            margin: 0 auto;
            padding: 0 24px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .navbar-brand {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 20px;
            font-weight: 700;
            color: #fff;
        }
        .navbar-brand .icon { font-size: 28px; }
        .navbar-brand .badge {
            background: linear-gradient(135deg, #4ade80, #22c55e);
            color: #000;
            font-size: 11px;
            padding: 2px 8px;
            border-radius: 10px;
            font-weight: 600;
        }
        
        /* ä¸»å®¹å™¨ */
        .main-container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 30px 24px;
        }
        
        /* ç»Ÿè®¡å¡ç‰‡ç½‘æ ¼ */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
        }
        .stat-card.purple::before { background: linear-gradient(90deg, #a855f7, #7c3aed); }
        .stat-card.pink::before { background: linear-gradient(90deg, #ec4899, #f472b6); }
        .stat-card.cyan::before { background: linear-gradient(90deg, #06b6d4, #22d3ee); }
        .stat-card.green::before { background: linear-gradient(90deg, #10b981, #34d399); }
        .stat-card .label {
            font-size: 12px;
            color: #8b949e;
            margin-bottom: 8px;
        }
        .stat-card .value {
            font-size: 28px;
            font-weight: 700;
        }
        .stat-card.purple .value { color: #a855f7; }
        .stat-card.pink .value { color: #ec4899; }
        .stat-card.cyan .value { color: #22d3ee; }
        .stat-card.green .value { color: #10b981; }
        
        /* åŒºå—æ ‡é¢˜ */
        .section-title {
            font-size: 18px;
            font-weight: 600;
            color: #e6edf3;
            margin-bottom: 20px;
        }
        
        /* å·¥å…·æ  */
        .toolbar {
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
        }
        .search-box {
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 10px 14px;
            color: #e6edf3;
            font-size: 14px;
            width: 220px;
            transition: all 0.2s;
        }
        .search-box:focus {
            outline: none;
            border-color: #a855f7;
            box-shadow: 0 0 0 3px rgba(168, 85, 247, 0.15);
        }
        .search-box::placeholder { color: #484f58; }
        .sort-select {
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 10px 14px;
            color: #e6edf3;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .sort-select:focus {
            outline: none;
            border-color: #a855f7;
        }
        
        /* æŒ‰é’®æ ·å¼ */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        .btn-primary {
            background: linear-gradient(135deg, #4ade80, #22c55e);
            color: #000;
            font-weight: 600;
        }
        .btn-primary:hover { opacity: 0.9; transform: translateY(-1px); }
        .btn-secondary {
            background: #21262d;
            border: 1px solid #30363d;
            color: #e6edf3;
        }
        .btn-secondary:hover { background: #30363d; }
        .btn-danger {
            background: rgba(239, 68, 68, 0.15);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #ef4444;
        }
        .btn-danger:hover { background: rgba(239, 68, 68, 0.25); }
        .btn-warning {
            background: rgba(245, 158, 11, 0.15);
            border: 1px solid rgba(245, 158, 11, 0.4);
            color: #f59e0b;
        }
        .btn-warning:hover { background: rgba(245, 158, 11, 0.25); }
        .btn-sm { padding: 6px 12px; font-size: 12px; }
        
        /* Key åˆ—è¡¨ */
        .keys-section { margin-top: 10px; }
        .keys-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 16px;
        }
        .keys-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .key-card {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 12px;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 16px;
            transition: all 0.2s;
        }
        .key-card:hover { border-color: #8b949e; }
        .key-card.disabled { opacity: 0.5; }
        .key-info { flex: 1; min-width: 200px; }
        .key-name {
            font-size: 15px;
            font-weight: 600;
            color: #e6edf3;
            margin-bottom: 6px;
        }
        .key-id {
            font-family: monospace;
            font-size: 13px;
            color: #8b949e;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .btn-copy {
            background: #21262d;
            border: 1px solid #30363d;
            color: #8b949e;
            cursor: pointer;
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 6px;
            transition: all 0.2s;
        }
        .btn-copy:hover { background: #30363d; color: #e6edf3; }
        
        /* Key ç»Ÿè®¡ */
        .key-stats {
            display: flex;
            gap: 24px;
            flex-wrap: wrap;
        }
        .key-stat {
            text-align: center;
            min-width: 70px;
        }
        .key-stat .label {
            font-size: 11px;
            color: #8b949e;
            margin-bottom: 4px;
        }
        .key-stat .value {
            font-size: 14px;
            font-weight: 600;
            color: #e6edf3;
        }
        .key-stat .value.warning { color: #fbbf24; }
        .key-stat .value.danger { color: #ef4444; }
        .key-stat .value.muted { color: #8b949e; font-size: 12px; }
        .progress-bar {
            width: 80px;
            height: 6px;
            background: #21262d;
            border-radius: 3px;
            overflow: hidden;
            margin-top: 6px;
        }
        .progress-bar .fill {
            height: 100%;
            background: linear-gradient(90deg, #10b981, #34d399);
            transition: width 0.3s;
        }
        .progress-bar .fill.warning { background: linear-gradient(90deg, #f59e0b, #fbbf24); }
        .progress-bar .fill.danger { background: linear-gradient(90deg, #ef4444, #f87171); }
        
        /* Key æ“ä½œ */
        .key-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        /* æ¨¡æ€æ¡† */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }
        .modal.active { display: flex; }
        .modal-content {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 16px;
            padding: 0;
            max-width: 500px;
            width: 100%;
            overflow: hidden;
        }
        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid #30363d;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .modal-header h3 {
            font-size: 18px;
            font-weight: 600;
            color: #e6edf3;
        }
        .modal-close {
            background: none;
            border: none;
            color: #8b949e;
            font-size: 24px;
            cursor: pointer;
            padding: 4px;
            line-height: 1;
        }
        .modal-close:hover { color: #e6edf3; }
        .modal-body { padding: 24px; }
        
        /* è¡¨å• */
        .form-group { margin-bottom: 20px; }
        .form-group label {
            display: block;
            font-size: 13px;
            color: #8b949e;
            margin-bottom: 8px;
        }
        .form-group input {
            width: 100%;
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 12px 16px;
            color: #e6edf3;
            font-size: 14px;
            transition: all 0.2s;
        }
        .form-group input:focus {
            outline: none;
            border-color: #a855f7;
            box-shadow: 0 0 0 3px rgba(168, 85, 247, 0.15);
        }
        .form-group input::placeholder { color: #484f58; }
        
        /* Key æ˜¾ç¤º */
        .key-display {
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 16px;
            font-family: monospace;
            font-size: 14px;
            color: #7ee787;
            word-break: break-all;
            margin: 16px 0;
        }
        
        /* ç©ºçŠ¶æ€ */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #8b949e;
        }
        .empty-state .icon { font-size: 48px; margin-bottom: 16px; }
        .empty-state p { font-size: 14px; margin-bottom: 20px; }
        .no-results {
            text-align: center;
            padding: 40px;
            color: #8b949e;
        }
        
        /* Toast */
        .toast {
            position: fixed;
            bottom: 24px;
            right: 24px;
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 14px 20px;
            color: #e6edf3;
            font-size: 14px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s;
            z-index: 2000;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .toast.show { transform: translateY(0); opacity: 1; }
        .toast.success { border-left: 4px solid #10b981; }
        .toast.error { border-left: 4px solid #ef4444; }
        
        /* å“åº”å¼ - iPad */
        @media (max-width: 1024px) {
            .key-card { gap: 12px; }
            .key-stats { gap: 16px; }
            .key-stat { min-width: 60px; }
        }
        
        /* å“åº”å¼ - å¹³æ¿ç«–å±/å¤§æ‰‹æœº */
        @media (max-width: 768px) {
            .navbar-inner { padding: 0 16px; }
            .navbar-brand span:not(.icon):not(.badge) { display: none; }
            .main-container { padding: 20px 16px; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .key-card { 
                flex-direction: column; 
                align-items: stretch;
                gap: 16px;
            }
            .key-info { margin-bottom: 4px; }
            .key-stats { 
                width: 100%; 
                justify-content: flex-start;
                gap: 20px;
                flex-wrap: wrap;
            }
            .key-stat { min-width: 70px; text-align: left; }
            .key-actions { 
                width: 100%; 
                justify-content: flex-start;
                padding-top: 12px;
                border-top: 1px solid #30363d;
            }
            .search-box { width: 100%; }
        }
        
        /* å“åº”å¼ - æ‰‹æœº */
        @media (max-width: 480px) {
            .stat-card .value { font-size: 24px; }
            .keys-header { flex-direction: column; align-items: stretch; gap: 12px; }
            .toolbar { flex-direction: column; }
            .key-stats { 
                display: grid;
                grid-template-columns: repeat(3, 1fr);
                gap: 12px;
            }
            .key-stat { 
                min-width: unset; 
                text-align: center;
            }
            .key-actions {
                display: grid;
                grid-template-columns: repeat(4, 1fr);
                gap: 8px;
            }
            .key-actions .btn { 
                padding: 8px 6px; 
                font-size: 11px;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <!-- é¡¶éƒ¨å¯¼èˆª -->
    <nav class="navbar">
        <div class="navbar-inner">
            <div class="navbar-brand">
                <span class="icon">ğŸ²</span>
                <span>API å¤§é”…é¥­</span>
                <span class="badge">ç®¡ç†ç«¯</span>
            </div>
            <button id="createKeyBtn" class="btn btn-primary">+ ç”Ÿæˆæ–° Key</button>
        </div>
    </nav>

    <!-- ä¸»å†…å®¹åŒº -->
    <div class="main-container">
        <!-- ç»Ÿè®¡å¡ç‰‡ -->
        <div class="stats-grid">
            <div class="stat-card purple">
                <div class="label">æ€» Key æ•°</div>
                <div class="value" id="totalKeys">0</div>
            </div>
            <div class="stat-card green">
                <div class="label">å·²å¯ç”¨</div>
                <div class="value" id="enabledKeys">0</div>
            </div>
            <div class="stat-card pink">
                <div class="label">ä»Šæ—¥æ€»è°ƒç”¨</div>
                <div class="value" id="todayUsage">0</div>
            </div>
            <div class="stat-card cyan">
                <div class="label">ç´¯è®¡è°ƒç”¨</div>
                <div class="value" id="totalUsage">0</div>
            </div>
        </div>

        <!-- ç³»ç»Ÿé…ç½®å¡ç‰‡ -->
        <div class="config-card" style="background: #161b22; border: 1px solid #30363d; border-radius: 12px; padding: 20px; margin-bottom: 24px;">
            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 16px;">
                <div>
                    <h3 style="font-size: 15px; font-weight: 600; color: #e6edf3; margin-bottom: 8px;">âš™ï¸ ç³»ç»Ÿé…ç½®</h3>
                    <p style="font-size: 13px; color: #8b949e;">
                        é»˜è®¤é™é¢: <span id="configLimit" style="color: #a855f7; font-weight: 600;">500</span> æ¬¡/å¤© | 
                        èµ„æºåŒ…: <span id="configBonus" style="color: #10b981; font-weight: 600;">300</span> æ¬¡/å‡­è¯ | 
                        æœ‰æ•ˆæœŸ: <span id="configDays" style="color: #22d3ee; font-weight: 600;">30</span> å¤©
                    </p>
                </div>
                <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                    <button class="btn btn-warning" onclick="showConfirmModal('applyLimit')">åº”ç”¨é™é¢</button>
                    <button class="btn btn-warning" onclick="showConfirmModal('applyBonus')">åº”ç”¨èµ„æºåŒ…</button>
                    <button class="btn btn-secondary" onclick="openConfigModal()">ä¿®æ”¹é…ç½®</button>
                </div>
            </div>
        </div>

        <!-- Key åˆ—è¡¨åŒºåŸŸ -->
        <div class="keys-section">
            <div class="keys-header">
                <h2 class="section-title" style="margin-bottom: 0;">Key åˆ—è¡¨</h2>
                <div class="toolbar">
                    <input type="text" id="searchBox" class="search-box" placeholder="æœç´¢åç§°æˆ– Key...">
                    <select id="sortSelect" class="sort-select">
                        <option value="name-asc">åç§° A-Z</option>
                        <option value="name-desc">åç§° Z-A</option>
                        <option value="usage-desc">ä»Šæ—¥ç”¨é‡ â†“</option>
                        <option value="usage-asc">ä»Šæ—¥ç”¨é‡ â†‘</option>
                        <option value="total-desc">ç´¯è®¡ç”¨é‡ â†“</option>
                        <option value="lastUsed-desc">æœ€è¿‘ä½¿ç”¨ â†“</option>
                        <option value="created-desc">åˆ›å»ºæ—¶é—´ â†“</option>
                    </select>
                </div>
            </div>
            <div id="keysList" class="keys-list"></div>
        </div>
    </div>

    <!-- åˆ›å»º Key æ¨¡æ€æ¡† -->
    <div id="createModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ç”Ÿæˆæ–° API Key</h3>
                <button class="modal-close" onclick="closeModal('createModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Key åç§° (å¯é€‰)</label>
                    <input type="text" id="keyName" placeholder="ä¾‹å¦‚ï¼šæµ‹è¯•ç”¨æˆ·1">
                </div>
                <div class="form-group">
                    <label>æ¯æ—¥è°ƒç”¨é™é¢</label>
                    <input type="number" id="keyLimit" placeholder="500" min="1">
                </div>
                <button class="btn btn-primary" style="width:100%" onclick="createKey()">ç”Ÿæˆ Key</button>
            </div>
        </div>
    </div>

    <!-- æ˜¾ç¤ºæ–° Key æ¨¡æ€æ¡† -->
    <div id="showKeyModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ğŸ‰ Key å·²ç”Ÿæˆ</h3>
                <button class="modal-close" onclick="closeModal('showKeyModal')">&times;</button>
            </div>
            <div class="modal-body">
                <p style="color:#8b949e;margin-bottom:10px">è¯·å¦¥å–„ä¿å­˜æ­¤ Keyï¼Œå…³é—­åå°†æ— æ³•å†æ¬¡æŸ¥çœ‹å®Œæ•´å†…å®¹ï¼š</p>
                <div class="key-display" id="newKeyDisplay"></div>
                <button class="btn btn-secondary" style="width:100%" onclick="copyKey()">ğŸ“‹ å¤åˆ¶ Key</button>
            </div>
        </div>
    </div>

    <!-- ä¿®æ”¹é™é¢æ¨¡æ€æ¡† -->
    <div id="editLimitModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ä¿®æ”¹æ¯æ—¥é™é¢</h3>
                <button class="modal-close" onclick="closeModal('editLimitModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>æ–°çš„æ¯æ—¥é™é¢</label>
                    <input type="number" id="newLimit" min="1">
                </div>
                <input type="hidden" id="editKeyId">
                <button class="btn btn-primary" style="width:100%" onclick="updateLimit()">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <!-- ç³»ç»Ÿé…ç½®æ¨¡æ€æ¡† -->
    <div id="configModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>âš™ï¸ ç³»ç»Ÿé…ç½®</h3>
                <button class="modal-close" onclick="closeModal('configModal')">&times;</button>
            </div>
            <div class="modal-body">
                <p style="color: #8b949e; font-size: 13px; margin-bottom: 20px;">
                    ä¿®æ”¹é…ç½®åç«‹å³ç”Ÿæ•ˆï¼ˆçƒ­æ›´æ–°ï¼‰ã€‚èµ„æºåŒ…å‰©ä½™æ¬¡æ•°ä¼šæ ¹æ®æ–°é…ç½®é‡æ–°è®¡ç®—ã€‚
                </p>
                <div class="form-group">
                    <label>é»˜è®¤æ¯æ—¥é™é¢</label>
                    <input type="number" id="configLimitInput" min="1" placeholder="500">
                </div>
                <div class="form-group">
                    <label>æ¯å‡­è¯èµ„æºåŒ…æ¬¡æ•°</label>
                    <input type="number" id="configBonusInput" min="0" placeholder="300">
                </div>
                <div class="form-group">
                    <label>èµ„æºåŒ…æœ‰æ•ˆæœŸï¼ˆå¤©ï¼‰</label>
                    <input type="number" id="configDaysInput" min="1" placeholder="30">
                </div>
                <button class="btn btn-primary" style="width:100%" onclick="updateConfig()">ä¿å­˜é…ç½®</button>
            </div>
        </div>
    </div>

    <!-- Toast æç¤º -->
    <div id="toast" class="toast"></div>

    <!-- æ‰¹é‡æ“ä½œç¡®è®¤å¼¹æ¡† -->
    <div id="confirmModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="confirmModalTitle">ç¡®è®¤æ“ä½œ</h3>
                <button class="modal-close" onclick="closeModal('confirmModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div id="confirmModalContent" style="margin-bottom: 20px;"></div>
                <div style="display: flex; gap: 12px; justify-content: flex-end;">
                    <button class="btn btn-secondary" onclick="closeModal('confirmModal')">å–æ¶ˆ</button>
                    <button id="confirmModalBtn" class="btn btn-danger" onclick="executeConfirmedAction()">ç¡®è®¤æ‰§è¡Œ</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentNewKey = '';
        let allKeys = [];
        let systemConfig = { defaultDailyLimit: 500, bonusPerCredential: 300, bonusValidityDays: 30 };
        let pendingAction = null; // å¾…ç¡®è®¤çš„æ“ä½œ
        const API_BASE = '/api/potluck';

        function getToken() { return localStorage.getItem('authToken'); }

        async function apiRequest(url, options = {}) {
            const token = getToken();
            const headers = { 'Content-Type': 'application/json', ...options.headers };
            if (token) headers['Authorization'] = `Bearer ${token}`;
            const response = await fetch(url, { ...options, headers });
            const data = await response.json();
            if (response.status === 401) { window.location.href = '/login.html'; return null; }
            return data;
        }

        async function loadData() {
            const result = await apiRequest(`${API_BASE}/keys`);
            if (!result || !result.success) { showToast('åŠ è½½å¤±è´¥', 'error'); return; }
            const { keys, stats, config } = result.data;
            if (config) {
                systemConfig = { ...systemConfig, ...config };
                // æ›´æ–°é…ç½®æ˜¾ç¤º
                document.getElementById('configLimit').textContent = config.defaultDailyLimit || 500;
                document.getElementById('configBonus').textContent = config.bonusPerCredential || 300;
                document.getElementById('configDays').textContent = config.bonusValidityDays || 30;
                document.getElementById('keyLimit').placeholder = config.defaultDailyLimit || 500;
            }
            document.getElementById('totalKeys').textContent = stats.totalKeys;
            document.getElementById('enabledKeys').textContent = stats.enabledKeys;
            document.getElementById('todayUsage').textContent = stats.todayTotalUsage;
            document.getElementById('totalUsage').textContent = stats.totalUsage;
            allKeys = keys;
            applyFilterAndSort();
        }

        async function updateConfig() {
            const defaultDailyLimit = parseInt(document.getElementById('configLimitInput').value);
            const bonusPerCredential = parseInt(document.getElementById('configBonusInput').value);
            const bonusValidityDays = parseInt(document.getElementById('configDaysInput').value);
            
            const body = {};
            if (!isNaN(defaultDailyLimit) && defaultDailyLimit >= 1) body.defaultDailyLimit = defaultDailyLimit;
            if (!isNaN(bonusPerCredential) && bonusPerCredential >= 0) body.bonusPerCredential = bonusPerCredential;
            if (!isNaN(bonusValidityDays) && bonusValidityDays >= 1) body.bonusValidityDays = bonusValidityDays;
            
            if (Object.keys(body).length === 0) {
                showToast('è¯·è¾“å…¥æœ‰æ•ˆçš„é…ç½®å€¼', 'error');
                return;
            }
            
            const result = await apiRequest(`${API_BASE}/config`, { method: 'PUT', body: JSON.stringify(body) });
            if (result && result.success) {
                showToast('é…ç½®å·²æ›´æ–°', 'success');
                closeModal('configModal');
                document.getElementById('configLimitInput').value = '';
                document.getElementById('configBonusInput').value = '';
                document.getElementById('configDaysInput').value = '';
                loadData();
            } else {
                showToast(result?.error?.message || 'æ›´æ–°å¤±è´¥', 'error');
            }
        }

        function applyFilterAndSort() {
            const searchTerm = document.getElementById('searchBox').value.toLowerCase().trim();
            const sortValue = document.getElementById('sortSelect').value;
            let filtered = allKeys;
            if (searchTerm) {
                filtered = allKeys.filter(k => k.name.toLowerCase().includes(searchTerm) || k.id.toLowerCase().includes(searchTerm));
            }
            const [field, order] = sortValue.split('-');
            filtered.sort((a, b) => {
                let va, vb;
                if (field === 'name') { va = a.name.toLowerCase(); vb = b.name.toLowerCase(); }
                else if (field === 'usage') { va = a.todayUsage; vb = b.todayUsage; }
                else if (field === 'total') { va = a.totalUsage; vb = b.totalUsage; }
                else if (field === 'lastUsed') { va = a.lastUsedAt || ''; vb = b.lastUsedAt || ''; }
                else if (field === 'created') { va = a.createdAt || ''; vb = b.createdAt || ''; }
                if (va < vb) return order === 'asc' ? -1 : 1;
                if (va > vb) return order === 'asc' ? 1 : -1;
                return 0;
            });
            renderKeys(filtered);
        }

        function formatTime(isoStr) {
            if (!isoStr) return 'ä»æœª';
            const d = new Date(isoStr);
            const now = new Date();
            const diff = now - d;
            if (diff < 60000) return 'åˆšåˆš';
            if (diff < 3600000) return Math.floor(diff / 60000) + 'åˆ†é’Ÿå‰';
            if (diff < 86400000) return Math.floor(diff / 3600000) + 'å°æ—¶å‰';
            if (diff < 604800000) return Math.floor(diff / 86400000) + 'å¤©å‰';
            return d.toLocaleDateString();
        }

        function renderKeys(keys) {
            const container = document.getElementById('keysList');
            if (allKeys.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="icon">ğŸ“­</div><p>è¿˜æ²¡æœ‰ä»»ä½• API Key</p><button class="btn btn-primary" onclick="openModal(\'createModal\')">ç”Ÿæˆç¬¬ä¸€ä¸ª Key</button></div>';
                return;
            }
            if (keys.length === 0) {
                container.innerHTML = '<div class="no-results">æ²¡æœ‰åŒ¹é…çš„ç»“æœ</div>';
                return;
            }
            container.innerHTML = keys.map(key => {
                const usagePercent = key.dailyLimit > 0 ? (key.todayUsage / key.dailyLimit * 100) : 0;
                const progressClass = usagePercent >= 90 ? 'danger' : usagePercent >= 70 ? 'warning' : '';
                const valueClass = usagePercent >= 90 ? 'danger' : usagePercent >= 70 ? 'warning' : '';
                const bonusRemaining = key.bonusRemaining || 0;
                return `<div class="key-card ${key.enabled ? '' : 'disabled'}">
                    <div class="key-info">
                        <div class="key-name">${escapeHtml(key.name)}</div>
                        <div class="key-id">${key.maskedKey} <button class="btn-copy" onclick="copyToClipboard('${key.id}')" title="å¤åˆ¶å®Œæ•´ Key">ğŸ“‹</button></div>
                    </div>
                    <div class="key-stats">
                        <div class="key-stat">
                            <div class="label">ä»Šæ—¥/é™é¢</div>
                            <div class="value ${valueClass}">${key.todayUsage}/${key.dailyLimit}</div>
                            <div class="progress-bar"><div class="fill ${progressClass}" style="width:${Math.min(usagePercent, 100)}%"></div></div>
                        </div>
                        <div class="key-stat">
                            <div class="label">èµ„æºåŒ…</div>
                            <div class="value" style="color:${bonusRemaining > 0 ? '#10b981' : '#8b949e'}">${bonusRemaining}</div>
                        </div>
                        <div class="key-stat">
                            <div class="label">ç´¯è®¡</div>
                            <div class="value">${key.totalUsage}</div>
                        </div>
                        <div class="key-stat">
                            <div class="label">æœ€åè°ƒç”¨</div>
                            <div class="value muted">${formatTime(key.lastUsedAt)}</div>
                        </div>
                        <div class="key-stat">
                            <div class="label">çŠ¶æ€</div>
                            <div class="value" style="color:${key.enabled ? '#10b981' : '#ef4444'}">${key.enabled ? 'å¯ç”¨' : 'ç¦ç”¨'}</div>
                        </div>
                    </div>
                    <div class="key-actions">
                        <button class="btn btn-secondary btn-sm" onclick="resetUsage('${key.id}')">é‡ç½®</button>
                        <button class="btn btn-secondary btn-sm" onclick="openEditLimit('${key.id}', ${key.dailyLimit})">é™é¢</button>
                        <button class="btn btn-secondary btn-sm" onclick="toggleKey('${key.id}')">${key.enabled ? 'ç¦ç”¨' : 'å¯ç”¨'}</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteKey('${key.id}')">åˆ é™¤</button>
                    </div>
                </div>`;
            }).join('');
        }

        async function createKey() {
            const name = document.getElementById('keyName').value;
            const dailyLimit = parseInt(document.getElementById('keyLimit').value) || systemConfig.defaultDailyLimit;
            const result = await apiRequest(`${API_BASE}/keys`, { method: 'POST', body: JSON.stringify({ name, dailyLimit }) });
            if (result && result.success) {
                currentNewKey = result.data.id;
                document.getElementById('newKeyDisplay').textContent = currentNewKey;
                closeModal('createModal');
                openModal('showKeyModal');
                loadData();
                document.getElementById('keyName').value = '';
                document.getElementById('keyLimit').value = '';
            } else {
                showToast(result?.error?.message || 'åˆ›å»ºå¤±è´¥', 'error');
            }
        }

        function copyToClipboardFallback(text) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.left = '-9999px';
            textArea.style.top = '-9999px';
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            try {
                document.execCommand('copy');
                showToast('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
            } catch (err) {
                showToast('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶', 'error');
            }
            document.body.removeChild(textArea);
        }

        function copyKey() {
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(currentNewKey).then(() => showToast('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success')).catch(() => copyToClipboardFallback(currentNewKey));
            } else {
                copyToClipboardFallback(currentNewKey);
            }
        }

        function copyToClipboard(text) {
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text).then(() => showToast('Key å·²å¤åˆ¶', 'success')).catch(() => copyToClipboardFallback(text));
            } else {
                copyToClipboardFallback(text);
            }
        }

        async function resetUsage(keyId) {
            if (!confirm('ç¡®å®šè¦é‡ç½®è¯¥ Key çš„ä»Šæ—¥è°ƒç”¨æ¬¡æ•°å—ï¼Ÿ')) return;
            const result = await apiRequest(`${API_BASE}/keys/${encodeURIComponent(keyId)}/reset`, { method: 'POST' });
            if (result && result.success) { showToast('å·²é‡ç½®', 'success'); loadData(); }
            else { showToast(result?.error?.message || 'æ“ä½œå¤±è´¥', 'error'); }
        }

        function openEditLimit(keyId, currentLimit) {
            document.getElementById('editKeyId').value = keyId;
            document.getElementById('newLimit').value = currentLimit;
            openModal('editLimitModal');
        }

        async function updateLimit() {
            const keyId = document.getElementById('editKeyId').value;
            const dailyLimit = parseInt(document.getElementById('newLimit').value);
            if (!dailyLimit || dailyLimit < 1) { showToast('è¯·è¾“å…¥æœ‰æ•ˆçš„é™é¢', 'error'); return; }
            const result = await apiRequest(`${API_BASE}/keys/${encodeURIComponent(keyId)}/limit`, { method: 'PUT', body: JSON.stringify({ dailyLimit }) });
            if (result && result.success) { showToast('é™é¢å·²æ›´æ–°', 'success'); closeModal('editLimitModal'); loadData(); }
            else { showToast(result?.error?.message || 'æ“ä½œå¤±è´¥', 'error'); }
        }

        async function toggleKey(keyId) {
            const result = await apiRequest(`${API_BASE}/keys/${encodeURIComponent(keyId)}/toggle`, { method: 'POST' });
            if (result && result.success) { showToast(result.message, 'success'); loadData(); }
            else { showToast(result?.error?.message || 'æ“ä½œå¤±è´¥', 'error'); }
        }

        async function deleteKey(keyId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¯¥ Key å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) return;
            const result = await apiRequest(`${API_BASE}/keys/${encodeURIComponent(keyId)}`, { method: 'DELETE' });
            if (result && result.success) { showToast('å·²åˆ é™¤', 'success'); loadData(); }
            else { showToast(result?.error?.message || 'åˆ é™¤å¤±è´¥', 'error'); }
        }

        function openModal(id) { document.getElementById(id).classList.add('active'); }
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }

        // æ˜¾ç¤ºç¡®è®¤å¼¹æ¡†
        function showConfirmModal(action) {
            pendingAction = action;
            const titleEl = document.getElementById('confirmModalTitle');
            const contentEl = document.getElementById('confirmModalContent');
            const btnEl = document.getElementById('confirmModalBtn');
            
            if (action === 'applyLimit') {
                titleEl.textContent = 'âš ï¸ æ‰¹é‡åº”ç”¨æ¯æ—¥é™é¢';
                contentEl.innerHTML = `
                    <p style="color: #e6edf3; margin-bottom: 12px;">æ­¤æ“ä½œå°†æŠŠå½“å‰é…ç½®çš„é»˜è®¤é™é¢ <strong style="color: #a855f7;">${systemConfig.defaultDailyLimit}</strong> æ¬¡/å¤© åº”ç”¨åˆ°æ‰€æœ‰ Keyã€‚</p>
                    <div style="background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 8px; padding: 12px; margin-top: 12px;">
                        <p style="color: #ef4444; font-size: 13px; margin: 0;">âš ï¸ é£é™©æç¤ºï¼š</p>
                        <ul style="color: #f87171; font-size: 12px; margin: 8px 0 0 16px; padding: 0;">
                            <li>æ‰€æœ‰ Key çš„æ¯æ—¥é™é¢å°†è¢«è¦†ç›–</li>
                            <li>å·²å•ç‹¬è®¾ç½®é™é¢çš„ Key ä¹Ÿä¼šè¢«ä¿®æ”¹</li>
                            <li>æ­¤æ“ä½œä¸å¯æ’¤é”€</li>
                        </ul>
                    </div>
                `;
                btnEl.textContent = 'ç¡®è®¤åº”ç”¨é™é¢';
            } else if (action === 'applyBonus') {
                titleEl.textContent = 'ğŸ”„ æ‰¹é‡åŒæ­¥èµ„æºåŒ…';
                contentEl.innerHTML = `
                    <p style="color: #e6edf3; margin-bottom: 12px;">æ­¤æ“ä½œå°†é‡æ–°åŒæ­¥æ‰€æœ‰ç”¨æˆ·çš„èµ„æºåŒ…çŠ¶æ€ã€‚</p>
                    <div style="background: rgba(34, 211, 238, 0.1); border: 1px solid rgba(34, 211, 238, 0.3); border-radius: 8px; padding: 12px; margin-top: 12px;">
                        <p style="color: #22d3ee; font-size: 13px; margin: 0;">ğŸ“‹ æ“ä½œè¯´æ˜ï¼š</p>
                        <ul style="color: #67e8f9; font-size: 12px; margin: 8px 0 0 16px; padding: 0;">
                            <li>æ£€æŸ¥æ‰€æœ‰ç”¨æˆ·çš„å‡­æ®å¥åº·çŠ¶æ€</li>
                            <li>ä¸ºå¥åº·å‡­æ®åˆ›å»º/æ›´æ–°èµ„æºåŒ…</li>
                            <li>ç§»é™¤å¤±æ•ˆå‡­æ®çš„èµ„æºåŒ…</li>
                            <li>æ›´æ–°å„ Key çš„å‰©ä½™èµ„æºåŒ…æ¬¡æ•°</li>
                        </ul>
                    </div>
                `;
                btnEl.textContent = 'ç¡®è®¤åŒæ­¥èµ„æºåŒ…';
                btnEl.className = 'btn btn-primary';
            }
            
            openModal('confirmModal');
        }

        // æ‰§è¡Œç¡®è®¤çš„æ“ä½œ
        async function executeConfirmedAction() {
            if (!pendingAction) return;
            
            closeModal('confirmModal');
            
            if (pendingAction === 'applyLimit') {
                await applyDailyLimitToAll();
            } else if (pendingAction === 'applyBonus') {
                await applyBonusToAll();
            }
            
            pendingAction = null;
            // é‡ç½®æŒ‰é’®æ ·å¼
            document.getElementById('confirmModalBtn').className = 'btn btn-danger';
        }

        // æ‰¹é‡åº”ç”¨æ¯æ—¥é™é¢
        async function applyDailyLimitToAll() {
            showToast('æ­£åœ¨åº”ç”¨é™é¢...', 'success');
            const result = await apiRequest(`${API_BASE}/keys/apply-limit`, { method: 'POST' });
            if (result && result.success) {
                showToast(result.message, 'success');
                loadData();
            } else {
                showToast(result?.error?.message || 'æ“ä½œå¤±è´¥', 'error');
            }
        }

        // æ‰¹é‡åŒæ­¥èµ„æºåŒ…
        async function applyBonusToAll() {
            showToast('æ­£åœ¨åŒæ­¥èµ„æºåŒ…...', 'success');
            const result = await apiRequest(`${API_BASE}/keys/apply-bonus`, { method: 'POST' });
            if (result && result.success) {
                showToast(result.message, 'success');
                loadData();
            } else {
                showToast(result?.error?.message || 'æ“ä½œå¤±è´¥', 'error');
            }
        }

        // æ‰“å¼€é…ç½®å¼¹æ¡†å¹¶åŠ è½½å½“å‰é…ç½®
        function openConfigModal() {
            document.getElementById('configLimitInput').value = systemConfig.defaultDailyLimit || '';
            document.getElementById('configBonusInput').value = systemConfig.bonusPerCredential || '';
            document.getElementById('configDaysInput').value = systemConfig.bonusValidityDays || '';
            openModal('configModal');
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type} show`;
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text || '';
            return div.innerHTML;
        }

        // äº‹ä»¶ç»‘å®š
        document.getElementById('createKeyBtn').addEventListener('click', () => openModal('createModal'));
        document.getElementById('searchBox').addEventListener('input', applyFilterAndSort);
        document.getElementById('sortSelect').addEventListener('change', applyFilterAndSort);

        // åˆå§‹åŒ–
        if (!getToken()) { window.location.href = '/login.html'; } else { loadData(); }
    </script>
</body>
</html>